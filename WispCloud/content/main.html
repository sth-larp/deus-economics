<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>DeusEx Economics</title>

<link rel="stylesheet" href="./css/styles.css">
<link rel="stylesheet" href="./css/top-menu.css">
<link rel="stylesheet" href="./css/left-menu.css">
<link rel="stylesheet" href="./css/mobile.css" media="(max-device-width:800px)">
<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="js/deus_api.js"></script>
<script type="text/javascript" src="js/slave_box.js"></script>

<script type="text/javascript">
    var main_account = '';
    var selected_account = '';
    var selected_role = ROLE.MASTER;
    var selected_acc_role = ACC_ROLE.PERSON;
    var main_profile = {}
    var lines_on_tab = 20;
    var corpNames = ['Serenity', 'Panam', 'JJ', 'Govt'];
    var httpOK = 200; //For errors debugging


    //------------------------------------------------------------------------------------------------------------------------------------------------------------
    //check if login is not set, return to login page
    function preLoad() {
        try {
            main_account = get_auth_tok_user(); //Временно, пока не получили истиный логин

            sendAPIRequest(url + "/api/accounts/profile?login=" + main_account, "GET", function(param, status) {
                if (status == httpOK) {
                    main_profile = JSON.parse(param);
                    main_account = main_profile.Login;
                    selected_account = main_account;
                    document.getElementById("current_account").innerHTML = "Привет, " + main_profile.Login;
                    load_profile_page(main_profile.Login);
                } else if (status == 401) {
                    loginRedirect();
                } else {
                    alert("Ошибка " + status + "\n" + param);
                }
            });
        } catch (e) {
            loginRedirect();
        }
    }

    function setCurrentAccount(acc, role) {
        selected_account = acc;
        selected_role = role;
        document.getElementById('corp_menu').style.display = 'none';

        sendAPIRequest(url + "/api/accounts/profile?login=" + selected_account, "GET", function(param, status) {
            if (status == httpOK) {
                main_profile = JSON.parse(param);
                load_profile_page(main_profile.Login);
            } else {
                alert(param + "\n\n" + status);
            }
        });
    }

    function fill_full_profile(param) {
        var prof = {};
        if (param.length > 0) {
            prof = JSON.parse(param);
            selected_acc_role = get_acc_role(prof.User.Role);
            //result mapping to visual elements
            document.getElementById("login_name").innerHTML = prof.User.Login + " ";
            document.getElementById("email").innerHTML = prof.User.Email + " ";
            document.getElementById("acc_role").innerHTML = get_acc_role(prof.User.Role).rusname + " ";
            document.getElementById("full_name").innerHTML = prof.User.Fullname + " ";
            document.getElementById("live_status").innerHTML = prof.User.Status + " ";
            document.getElementById("current_account_value").innerHTML = prof.User.Cash;

            document.getElementById("insurance_label").style.display = "none";
            document.getElementById("index_label").style.display = "none";
            document.getElementById("index_p_label").style.display = "none";

            if (selected_acc_role == ACC_ROLE.CORP) {
                document.getElementById("current_index").innerHTML = prof.User.Index;
                document.getElementById("index_points").innerHTML = prof.User.InsurancePoints;
                document.getElementById("index_label").style.display = "table-row";
                document.getElementById("index_p_label").style.display = "table-row";
            }

            if (selected_acc_role == ACC_ROLE.CORP || selected_acc_role == ACC_ROLE.COMPANY) {
                document.getElementById('corp_menu').style.display = 'block';
            }

            if (selected_acc_role == ACC_ROLE.PERSON) {
                document.getElementById("insurance_label").style.display = "table-row";
                //document.getElementById("index_label").style.display = "none";
                document.getElementById("insurance").innerHTML = prof.User.Insurance;
                document.getElementById("insurance_level").innerHTML = prof.User.InsuranceLevel;
            }

            var hist = "<tr><th>Время</th><th>Событие</th></tr>";
            for (i = 0; i < prof.History.length; i++) {
                hist += "<tr><td>" + customDateFormat(prof.History[i].Time) + "</td>";
                hist += "<td>" + prof.History[i].Description + "</td></tr>";
            }
            document.getElementById("history").innerHTML = hist;
        }
    }


    function load_profile_page() {
        topMenuSwitch(document.getElementById("profile_menu"));
        document.getElementById("profile_page").style.display = "block";

        sendAPIRequest(url + "/api/accounts/fullprofile?login=" + selected_account, "GET", function(param, status) {
            if (status == httpOK)
                fill_full_profile(param);
            else
                fillError("history-warning", param, status);
        });

        load_slaves();
        load_masters();
    }

    function load_masters() {
        sendAPIRequest(url + "/api/accounts/access/masters?slave=" + selected_account, "GET", function(param, status) {
            $("#masters-table tbody tr").remove();
            if (status == httpOK) {
                var masters = JSON.parse(param);
                $('#masters-table').append('<tr><th>Пользователь</th><th colspan=2>Роль</th></tr>');

                var row = "<tr><td>{0}</td><td>{1}</td><td><img src=\"./image/cross-icon.png\" class=\"btn-image\" onClick=\"cancelMaster('{0}');\"/></td></tr>";
                var rowNormal = "<tr><td>{0}</td><td>{1}</td><td></td></tr>";
                if (selected_role.value < ROLE.ADMIN.value)
                    row = rowNormal;

                for (i = 0; i < masters.length; i++) {
                    var roleRus = get_role(masters[i].Role).rusname;
                    var newRow = format(row, [masters[i].Master, roleRus]);
                    $('#masters-table').append(newRow);
                }

                if(selected_role.value >= ROLE.ADMIN.value)
                    $('#masters-table').append("<tr><td><input type=\"button\" class=\"custom-button smaller\" value=\"Добавить\" onclick=\"fill_add_master_menu();\"/></td><td></td><td></td></tr>");
            }
            else {
                fillError("masters-table-warning", param, status);
            }
        });
    }


    function load_slaves() {
        sendAPIRequest(url + "/api/accounts/access/slaves?master=" + selected_account, "GET", function(param, status) {
            $("#slaves-table tbody tr").remove();
            
            if (status == httpOK) {
                if (selected_account == main_account)
                    fill_slave_menu(param, main_account);

                var slaves = JSON.parse(param);
                var row = "<tr><td>{0}</td><td>{1}</td><td><img src=\"./image/cross-icon.png\" class=\"btn-image\" onClick=\"cancelAccess('{0}');\"/></td></tr>";
                var rowNormal = "<tr><td>{0}</td><td>{1}</td><td></td></tr>";

                if (selected_role.value < ROLE.ADMIN.value)
                    row = rowNormal;

                if(slaves.length > 0)
                    $('#slaves-table').append('<tr><th>Пользователь</th><th colspan=2>Роль</th></tr>');

                for (i = 0; i < slaves.length; i++) {
                    var roleRus = get_role(slaves[i].Role).rusname;
                    var newRow = format(row, [slaves[i].Slave, roleRus]);
                    $('#slaves-table').append(newRow);
                }
            }
            else {
                fillError("slaves-table-warning", param, status);
                if (selected_account == main_account)
                    fillError("leftmenu-warning", param, status);
            }
        });
    }

    function cancelAccess(slave) {
        //TODO вставить диалог
        var data = JSON.stringify({ "MasterLogin": selected_account, "SlaveLogin": slave, "Role": "None" });
        sendAPIRequest(url + "/api/accounts/access/set", "POST", function (param, status) {
            if (status == httpOK)
                //if (selected_account == main_account) //    window.location.reload(false); //Потому что еще левый список есть //load_profile_page();
                load_slaves();
            else
                fillError("slaves-table-warning", param, status);
        }, data);
    }

    function cancelMaster(master) {
        //TODO вставить диалог
        var data = JSON.stringify({ "MasterLogin": master, "SlaveLogin": selected_account, "Role": "None" });
        sendAPIRequest(url + "/api/accounts/access/set", "POST", function (param, status) {
            if (status == httpOK) {
                if (main_account == master)
                    window.location.reload(false); //Потому что еще левый список есть
                load_masters();
            }
            else
                fillError("masters-table-warning", param, status);
        }, data);
    }

    function load_transactions_page() {
        topMenuSwitch(document.getElementById("transactions_menu"));
        document.getElementById("transactions").style.display = "block";
        document.getElementById("trans_menu_holder").style.display = selected_role.value >= ROLE.WITHDRAW.value ? 'block' : 'none';

        load_transactions();
    }

    function load_transactions() {
        document.getElementById("lines_on_tab").value = lines_on_tab;
        document.getElementById("lines_on_tab").onchange = function() {
            lines_on_tab = document.getElementById("lines_on_tab").value;
            //should rebuild transactions table here
            sendAPIRequest(url + "/api/transactions?login=" + selected_account, "GET", function(param, status) {
                fill_transactions_table(param, status)
            });
        }
        sendAPIRequest(url + "/api/transactions?login=" + selected_account, "GET", function (param, status) {
            if (status == httpOK)
                fill_transactions_table(param, status);
            else
                fillError("transactions-warning", param, status);
        });
    }

    function sendTransaction(elem) {
        var user = document.getElementById("user_name_id").value;
        var sum = document.getElementById("transaction_value_id").value;
        var comment = document.getElementById("transaction_comment_id").value;
        var data = JSON.stringify({ "Sender": selected_account, "Receiver": user, "Amount": sum, "Description": comment });

        sendAPIRequest(url + "/api/transfer", "POST", function(param, status) {
            if (status == httpOK) {
                document.getElementById("send-tran-warning").innerHTML = "";
                load_transactions();
            } else
                fillError("send-tran-warning", param, status);
        }, data);
    }

    function fill_transactions_table(param) {
        var t_list = JSON.parse(param);
        var head_str = "<tr><th>Перевел</th><th>Получил</th><th>Время</th><th>Сумма</th><th>Комментарий</th></tr>";
        var t_str = [];
        for (i = 0; i < t_list.length; i++) {
            t_str[i] = "<tr><td>" + t_list[i].Sender
                + "</td><td>" + t_list[i].Receiver + "</td><td>" + customDateFormat(t_list[i].Time)
                + "</td><td>" + t_list[i].Amount + "</td><td>" + t_list[i].Comment + "</td></tr>";
        }
        var page_str = buildTabs(t_str, lines_on_tab, "transaction_table", head_str);
        document.getElementById("transactions_list").innerHTML = page_str;
        var t = document.getElementById("transaction_table_0");
        if (t != null) t.style.display = "block";
        initTabsControl("transaction_table");
    }

    function load_corp_page() {
        topMenuSwitch(document.getElementById("corp_menu"));
        document.getElementById("corp_admin").style.display = 'block';

        load_ins_holders();

        load_loyalties();

        //payments
        sendAPIRequest(url + "/api/payments/list?login=" + selected_account, "GET", function(param, status) {
            if (status == httpOK) {
                var payments = JSON.parse(param);
                var head_str = "<tr><th>Сотрудник</th><th>Зарплата</th><th>Последняя выплата</th></tr>";
                var l_str = [];
                for (i = 0; i < payments.length; i++) {

                    l_str[i] = "<tr><td>" + payments[i].ReceiverName +
                        "</td><td>" + payments[i].Amount +
                        "</td><td>" + customDateFormat(payments[i].LastPaid) + "</td></tr>";
                }
                var page_str = buildTabs(l_str, lines_on_tab, "payments-table", head_str);
                document.getElementById("payments_list").innerHTML = page_str;
                var t = document.getElementById("payments-table_0");
                if (t != null) t.style.display = "block";

                initTabsControl("payments-table");
            }
            else
                fillError("payments-warning", param, status);
        });
    }

    function load_ins_holders() {
        if (corpNames.indexOf(selected_account) == -1) return;

        document.getElementById("insurance-holder").style.display = 'block';
        $('#insurance-table').append('<tr><th>Пользователь</th><th>Уровень</th></tr>');

        sendAPIRequest(url + "/api/insurance/holders?company=" + selected_account, "GET", function(param, status) {
            $("#insurance-table tbody tr").remove();
            $('#insurance-table').append('<tr><th>Пользователь</th><th>Уровень</th><th></th></tr>');
            if (status == httpOK) {
                var holders = JSON.parse(param);
                var row = "<tr><td>{0} ({1})</td><td>{2}</td><td><img src=\"./image/cross-icon.png\" class=\"btn-image\" onClick=\"cancelHolder('{1}');\"/></td></tr>";
                var rowNormal = "<tr><td>{0} ({1})</td><td>{2}</td><td></td></tr>";

                if (selected_role.value < ROLE.WITHDRAW.value)
                    row = rowNormal;

                for (i = 0; i < holders.length; i++) {
                    var newRow = format(row, [holders[i].UserFullname, holders[i].UserLogin, holders[i].InsuranceLevel]);
                    $('#insurance-table').append(newRow);
                }

                if (selected_role.value >= ROLE.WITHDRAW.value) {
                    $('#insurance-table').append("<tr><td><input type=\"button\" class=\"custom-button smaller\" value=\"Добавить\" onclick=\"fill_add_insurance_menu();\"/></td><td><select id=\"level-selector\"><option value=\"1\">1</option><option value=\"2\">2</option><option value=\"3\">3</option></td><td></td></tr>");
                }
            } else {
                document.getElementById("ins-table-warning").innerHTML = param;
            }
        });
    }

    function load_loyalties() {
        if (corpNames.indexOf(selected_account) == -1) return;

        document.getElementById("loyalty-holder").style.display = 'block';
        $('#loyalty-table').append('<tr><th>Пользователь</th><th>Уровень</th></tr>');

        sendAPIRequest(url + "/api/insurance/loyals", "GET", function(param, status) {
            $("#loyalty-table tbody tr").remove();
            $('#loyalty-table').append('<tr><th>Компания</th><th>iD</th></tr>');
            if (status == httpOK) {
                var loyals = JSON.parse(param);
                var row = "<tr><td>{0}</td><td>{1}</td></tr>";

                for (i = 0; i < loyals.length; i++) {
                    if (loyals[i].Insurance != selected_account) continue;

                    var newRow = format(row, [loyals[i].LoyalFullName, loyals[i].LoyalName]);
                    $('#loyalty-table').append(newRow);
                }
            } else {
                document.getElementById("loyalty-table-warning").innerHTML = param;
            }
        });
    }

    function cancelHolder(holder) {
        sendAPIRequest(url + "/api/insurance/removeholder?user=" + holder, "POST", function(param, status) {
            if (status == httpOK) {
                load_corp_page();
            } else {
                document.getElementById("ins-table-warning").innerHTML = param;
            }
        });
    }

    function fill_add_insurance_menu() {
        document.getElementById('ins_form_name').innerHTML = selected_account;
        var e = document.getElementById('level-selector');
        document.getElementById('ins_form_level').innerHTML = e.options[e.selectedIndex].value;
        document.getElementById('add_ins_overlay').style.display = 'flex';
        document.getElementById('add_ins_warning').innerHTML = "";
    }

    function fill_add_master_menu() {
        document.getElementById('master_form_user').value = "";
        document.getElementById('add_master_overlay').style.display = 'flex';
        document.getElementById('add_master_warning').innerHTML = "";
    }

    function run_add_insurance() {
        document.getElementById("add_ins_warning").innerHTML = "";
        var level = document.getElementById('ins_form_level').innerHTML;
        var holder = document.getElementById('ins_form_user').value;
        var pass = document.getElementById('ins_form_pass').value;
        var data = JSON.stringify({ "Company": selected_account, "Holder": holder, "Password": pass, "Level": level });
        sendAPIRequest(url + "/api/insurance/changeholder", "POST", function(param, status) {
            if (status == httpOK) {
                hide_add_ins_menu();
                load_corp_page();
            } else {
                document.getElementById("add_ins_warning").innerHTML = param;
            }
        }, data);
    }

    function run_add_master() {
        document.getElementById("add_master_warning").innerHTML = "";
        var master = document.getElementById('master_form_user').value;
        var role = document.getElementById('master_form_role').value;
        var data = JSON.stringify({ "MasterLogin": master, "SlaveLogin": selected_account, "Role": role });
        sendAPIRequest(url + "/api/accounts/access/set", "POST", function (param, status) {
            if (status == httpOK) {
                hide_add_master_menu();
                load_profile_page();
            } else {
                document.getElementById("add_master_warning").innerHTML = param;
            }
        }, data);
    }

    function hide_add_ins_menu() {
        document.getElementById('add_ins_overlay').style.display = 'none';
        document.getElementById('ins_form_pass').value = '';
        document.getElementById('ins_form_user').value = '';
    }

    function hide_add_master_menu() {
        document.getElementById('add_master_overlay').style.display = 'none';
        document.getElementById('master_form_user').value = '';
    }

    function createHandler(obj, handler) {
        return function() { handler(obj); }
    }

    function topMenuSwitch(e) {
        $('.top-menu-elem').removeClass('top-menu-selected');
        e.classList.add('top-menu-selected');
        $('.page-display').css('display', 'none');
    }

    function showLeftMenu(x) {
        if (x) document.getElementById("left_menu").classList.add('mobile-visible');
        else document.getElementById("left_menu").classList.remove('mobile-visible');
    }
</script>
</head>


<body onload="preLoad();">

<div id="top_menu" class="top-menu">
    <div id="menu-icon" class="top-menu-elem" onclick="showLeftMenu(true);">&#9776;</div>
    <div id="current_account" class="top-menu-elem greetings">Привет,</div>
    <div id="profile_menu" class="top-menu-elem top-menu-selected" onclick="load_profile_page();">Профиль</div>
    <div id="corp_menu" class="top-menu-elem" style="display: none;" onclick="load_corp_page();">Управление</div>
    <div id="transactions_menu" class="top-menu-elem" onclick="load_transactions_page();">Переводы</div>
    <div id="logout_menu" class="top-menu-elem logout" onclick="loginRedirect();">Выйти</div>
</div>

<div id="left_menu" class="left-menu">
    <div class="slave-menu-head">Ваши счета</div>
    <div id="slave-list">
    <div class="warning-text" id="leftmenu-warning"></div>
    </div>
</div>

<div id="content-wrapper">
    <div id="content-preceder"></div>
    <div id="content-body">

        <!-- Страница Профиль -->

        <div id="profile_page" class="page-display">
            <h2>Профиль</h2>
            <table class="narrow">
                <tr><td>Логин:</td><td id="login_name"></td></tr>
                <tr><td>Полное имя:</td><td id="full_name"></td></tr>
                <tr><td>Email:</td><td id="email"></td></tr>
                <tr><td>Тип:</td><td id="acc_role"></td></tr>
                <tr><td>Статус:</td><td id="live_status"></td></tr>
                <tr><td>Кредиты:</td><td id="current_account_value"></td></tr>
                <tr id="index_label" style="display: none;"><td>Индекс:</td><td id="current_index"></td></tr>
                <tr id="index_p_label" style="display: none;"><td>Очки страховки:</td><td id="index_points"></td></tr>
                <tr id="insurance_label" style="display: none;"><td>Страховка:</td><td><span id="insurance"></span>(<span id="insurance_level"></span>)</td></tr>
            </table>

            <div id="slaves_list">
                <h2>Ваши доступы</h2>
                <p>Список пользователей, к которым вы имеете доступ</p>
                <table id="slaves-table"></table>
                <div id="slaves-table-warning" class="warning-text"></div>
            </div>

            <div id="masters_list">
                <h2>Доверенные лица</h2>
                <p>Список пользователей, которые имеют доступ к вам</p>
                <table id="masters-table"></table>
                <div id="masters-table-warning" class="warning-text"></div>
            </div>

            <div>
                <h2>События</h2>
                <table id="history"></table>
                <div class="warning-text" id="history-warning"></div>
            </div>
        </div>

        <!-- Страница Управление -->

        <div id="corp_admin" class="page-display">
            <div id="insurance-holder" style="display: none;">
                <h2>Страховки</h2>
                <p>Перечень лиц, имеющих вашу страховку. При добавлении лиц в список с вас списываются очки страховки. При удалении страховки потраченные очки не возвращаются. </p>
                <table id="insurance-table"></table>
                <div class="warning-text" id="ins-table-warning"></div>
            </div>

            <div id="loyalty-holder" style="display: none;">
                <h2>Заведения</h2>
                <p>Перечень заведений, которые обслуживают вашу страховку. Если вы хотите добавить или удалить какое-то заведение, обратитесь к Администрации.</p>
                <table id="loyalty-table"></table>
                <div class="warning-text" id="loyalty-table-warning"></div>
            </div>

            <div id="emloyee-holder">
                <h2>Сотрудники</h2>
                <div id="payments_list"></div>
                <div class="warning-text" id="payments-warning"></div>
            </div>
        </div>

        <!-- Страница Переводы -->

        <div id="transactions" class="page-display">
            <div id="trans_menu_holder">
                <h2>Выполнить перевод</h2>
                <form id="new_transaction" action="">
                    <table class="clear-table">
                        <tr><td>Кому</td><td><input type="text" id="user_name_id" name="user_name" value="master"/></td></tr>
                        <tr><td>Сумма</td><td><input type="text" id="transaction_value_id" name="transaction_value" value="0"/></td></tr>
                        <tr><td>Комментарий</td><td><input type="text" id="transaction_comment_id" name="transaction_comment" value="Frontend"/></td></tr>
                        <tr><td colspan=2><input type="button" class="custom-button smaller" name="send" value="Отправить" onClick="sendTransaction();"/></td></tr>
                    </table>
                </form>
                <div class="warning-text" id="send-tran-warning"></div>
            </div>
            <div>
                <h2>История операций</h2>
                <div style="display: none;">
                    <span>Количество строк на странице</span>
                    <select id="lines_on_tab">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div id="transactions_list">
                </div>
                <div class="warning-text" id="transactions-warning"></div>
            </div>
        </div>

    </div>
</div>

<div id="add_ins_overlay" class="disabling-div">
    <div style="float: left; margin: 0 auto;">
        <p>Необходимо получить согласие человека, который получит страховку</p>
        <p>Прошлая страховка будет отменена!</p>
        <table>
            <tr><td>Страховка:</td><td id="ins_form_name" value="">#CORP</td></tr>
            <tr><td>Уровень:</td><td id="ins_form_level" value=""></td></tr>
            <tr><td>Логин:</td><td><input id="ins_form_user" type="text" value=""/></td></tr>
            <tr><td>Пароль:</td><td><input id="ins_form_pass" type="password" value=""/></td></tr>
            <tr>
                <td>
                    <input type="button" class="custom-button smaller" value="Отменить" onclick="hide_add_ins_menu();"/>
                </td>
                <td>
                    <input type="button" class="custom-button smaller" value="Принять" onclick="run_add_insurance();"/>
                </td>
            </tr>
        </table>
        <div class="warning-text" id="add_ins_warning"></div>
    </div>
</div>

<div id="add_master_overlay" class="disabling-div">
    <div style="float: left; margin: 0 auto;">
        <p>Вы можете дать любому пользователю права на использование вашего счета</p>
        <p>Чтение: возможность просматривать любую информацию, но не менять ее</p>
        <p>Снятие: возможность делать переводы, выдавать страховки</p>
        <p>Админ: возможность, помимо переводов, управлять правами доступа</p>
        <table>
            <tr><td>Права:</td><td><select id="master_form_role"><option value="Read">Чтение</option><option value="Withdraw">Снятие</option><option value="Admin">Админ</option></select></td></tr>
            <tr><td>Логин:</td><td><input id="master_form_user" type="text" value=""/></td></tr>
            <tr>
                <td>
                    <input type="button" class="custom-button smaller" value="Отменить" onclick="hide_add_master_menu();"/>
                </td>
                <td>
                    <input type="button" class="custom-button smaller" value="Принять" onclick="run_add_master();"/>
                </td>
            </tr>
        </table>
        <div class="warning-text" id="add_master_warning"></div>
    </div>
</div>
</body>
</html>
