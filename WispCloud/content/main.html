<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>DeusEx Economical Trash</title>

<script src="js/deus_api.js"></script>

<script type="text/javascript">
    var main_account = 'admin';
    var selected_account = 'admin';
    var main_profile = {}
    var lines_on_tab = 10;

    //get logged in profile as global var
    sendAPIRequest(url + "/api/accounts/profile?login=" + main_account, "GET", function(param, status)	
    {
        if (status == 200) {
            main_profile = JSON.parse(param);
            document.getElementById("current_account").innerHTML = "Пользователь " + main_profile.Login;
            load_profile(main_profile.Login);
        }
        else if (status == 401) {
            window.location.assign(url + "/content/login.html");
        }
    }); 
//---------------------------------------------------------------------------------------------------------------------------------------------------			
//mok pages for local testing			

//profile page mok
    var p_page = '<div id="profile_page" style="width:100%; height:100%"> \
	<div><span> Логин:</span><span id="login_name"></span></div>\
	<div><span> Полное имя:</span><span id="full_name"></span></div>\
	<div><span> Статус: </span><span id="live_status"></span></div>\
	<span id="index_label" style="display: none;">\
	<div><span> Индекс: </span><span id="current_index"></span>\
		<span> Потраченный индекс: </span><span id="spent_index"></span></div>\
	</span>\
	<div><span> Деньги: </span><span id="current_account_value"></span></div>\
	<div><span> Страховка: </span><span id="insurance"></span>\
	<span> Уровень страховки: </span><span id="insurance_level"></span>\
	<span> Очки страховки страховки: </span><span id="insurance_points"></span></div>\
	<div>\
		<table id="slave_list">\
		</table>\
	</div>\
	<div>\
		<table id="masters_list">\
		</table>	\
	</div>\
	<div>\
		<table id="history">\
		</table>\
	</div>\
	<div id="insurances_supported" style="display: none;">\
		<table id="insurance_supported_list">\
		</table>\
	</div>\
</div>';

//corp admin page mok
    var ca_page = '';

//transactions page mok
    var t_page = '<div id="transactions" style="width:100%; height:100%">\
	<div id="trans_menu_holder">\
		<div>Выполнить платеж</div>\
		<form id="new_transaction" action="">\
			<table>\
				<tr><th>Кому</th><th>Сумма</th><th>Комментарий</th><th></th></tr>\
				<tr>\
					<td><input type="text" id="user_name_id" name="user_name" value="NAME"/></td>\
					<td><input type="text" id="transaction_value_id" name="transaction_value" value="0"/></td>\
					<td><input type="text" id="transaction_comment_id" name="transaction_comment" value="COMMENT"/></td>\
					<td><input type="button" id="send_transaction" name="send" value="SEND"/></td>\
				</tr>\
			</table>\
		</form>\
	</div>\
	<div>\
		<div><span>История операций</span><br/><span>Количество строк на странице</span>\
			<select id="lines_on_tab">\
				<option value="5">5</option>\
				<option value="10">10</option>\
				<option value="20">20</option>\
				<option value="30">30</option>\
				<option value="50">50</option>\
				<option value="100">100</option>\
			</select>\
		</div>\
		<div id="transactions_list">\
		</div>\
		<div><span id="back_link"><<Назад  </span><span id="fw_link">  Вперед>></span></div>\
	</div>\
</div>';

//------------------------------------------------------------------------------------------------------------------------------------------------------------
    //check if login is not set, return to login page

    function buildTabs(elements_list, lines_per_page, page_id_prefix, header_str = "") {
        var result = "";
        //count of pages
        for (offset = 0; offset * lines_per_page < elements_list.length; offset++) {
            result = result + "<table id = '" + page_id_prefix + "_" + offset + "' style='display: none'>" + header_str;
            var tmp_limit = lines_per_page;
            if (offset * lines_per_page + lines_per_page > elements_list.length) {
                tmp_limit = elements_list.length - offset * lines_per_page;
            }
            for (i = 0; i < tmp_limit; i++) result = result + elements_list[offset * lines_per_page + i];
            result = result + "</table>";
        }
        //change_page_buttons

        return result;
    }

    function logout(p_name) {
        //delete auth token, redirect to login page
        alert('Buy');
        window.location.href = url + "/login.html";
    }

    function insertDocumentToWrapper(wrapper_id, document_href, rq_type) {
        //load sub-page into wrapper
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) document.getElementById(wrapper_id).innerHTML = xhttp.responseText;
        };
        xhttp.open(rq_type, document_href, true);
        xhttp.setRequestHeader("Authorization", get_auth_tok());
        xhttp.send();
    }

    function load_profile(p_name) {
        //insertDocumentToWrapper("content_wrapper", url + "/profile_page.html","GET");
        //mok html for localtesting, replace^ before deploy
        document.getElementById("content_wrapper").innerHTML = p_page;
        //get general profile info
        sendAPIRequest(url + "/api/accounts/fullprofile?login=" + p_name, "GET", function(param, status) {
                var prof = {};
                if (param.length > 0) {
                    prof = JSON.parse(param);
                    //result mapping to visual elements							
                    document.getElementById("login_name").innerHTML = prof.User.Login + " ";
                    document.getElementById("full_name").innerHTML = prof.User.Fullname + " ";
                    document.getElementById("live_status").innerHTML = prof.User.Status + " ";
                    prof.isCorp = prof.User.Roles.includes("Corp");
                    if (prof.isCorp) {
                        document.getElementById("current_index").innerHTML = prof.User.Index;
                        document.getElementById("spent_index").innerHTML = prof.User.Index;
                        document.getElementById("index_label").style.display = "inline";
                        document.getElementById("insurances_supported").style.display = "block";

                    }
                    document.getElementById("current_account_value").innerHTML = prof.User.Cash;
                    document.getElementById("insurance").innerHTML = prof.User.Insurance;
                    document.getElementById("insurance_level").innerHTML = prof.User.InsuranceLevel;
                    document.getElementById("insurance_points").innerHTML = prof.User.InsurancePoints;
                    var history_html = "<tr><th>Id</th><th>User</th><th>Time</th><th>Type</th><th>Description</th></tr>";
                    for (i = 0; i < prof.History.length; i++) {
                        history_html = history_html + "<tr><td>" + prof.History[i].Id + "</td>";
                        history_html = history_html + "<td>" + prof.History[i].User + "</td>";
                        history_html = history_html + "<td>" + prof.History[i].Time + "</td>";
                        history_html = history_html + "<td>" + prof.History[i].Type + "</td>";
                        history_html = history_html + "<td>" + prof.History[i].Description + "</td>";
                        history_html = history_html + "</tr>";
                    }
                    document.getElementById("history").innerHTML = history_html;
                }
            }
        );
        //get slaves
        sendAPIRequest(url + "/api/accounts/access/slaves?master=" + p_name, "GET", function(param, status) {
        });
        //get masters
        sendAPIRequest(url + "/api/accounts/access/masters?slave=" + p_name, "GET", function(param, status) {
        });
        //get supported insurances (for corps only)

    }

    function load_transactions(p_name) {
        //insertDocumentToWrapper("content_wrapper", url + "/transactions.html","GET");
        //mok html for localtesting, replace^ before deploy
        document.getElementById("content_wrapper").innerHTML = t_page;
        document.getElementById("lines_on_tab").value = lines_on_tab;
        document.getElementById("lines_on_tab").onchange = function() {
            lines_on_tab = document.getElementById("lines_on_tab").value;
            //should rebuild transactions table here
            sendAPIRequest(url + "/api/transactions?login=" + p_name, "GET", function(param, status) {
                var t_list = JSON.parse(param);
                var head_str = "<tr><th>Id</th><th>Отправитель</th><th>Получатель</th><th>Дата</th><th>Сумма</th><th>Комментарий</th></tr>";
                var page_str = "";
                var t_str = [];
                for (i = 0; i < t_list.length; i++) {
                    t_str[i] = "<tr><td>" + t_list[i].Id + "</td><td>" + t_list[i].Sender + "</td><td>" + t_list[i].Receiver + "</td><td>" + t_list[i].Time + "</td>";
                    t_str[i] = t_str[i] + "<td>" + t_list[i].Amount + "</td><td>" + t_list[i].Comment + "</td></tr>";
                }
                page_str = buildTabs(t_str, lines_on_tab, "transaction_table", head_str);
                document.getElementById("transactions_list").innerHTML = page_str;
                document.getElementById("transaction_table_0").style.display = "block";
            });
        }
        sendAPIRequest(url + "/api/transactions?login=" + p_name, "GET", function(param, status) {
            var t_list = JSON.parse(param);
            var head_str = "<tr><th>Id</th><th>Отправитель</th><th>Получатель</th><th>Дата</th><th>Сумма</th><th>Комментарий</th></tr>";
            var page_str = "";
            var t_str = [];
            for (i = 0; i < t_list.length; i++) {
                t_str[i] = "<tr><td>" + t_list[i].Id + "</td><td>" + t_list[i].Sender + "</td><td>" + t_list[i].Receiver + "</td><td>" + t_list[i].Time + "</td>";
                t_str[i] = t_str[i] + "<td>" + t_list[i].Amount + "</td><td>" + t_list[i].Comment + "</td></tr>";
            }
            page_str = buildTabs(t_str, lines_on_tab, "transaction_table", head_str);
            document.getElementById("transactions_list").innerHTML = page_str;
            document.getElementById("transaction_table_0").style.display = "block";
        });
    }

    function load_corp_admin(p_name) {
    }

    function createHandler(obj, handler) {
        return function() { handler(obj); }
    }

    function onButton(obj) {
        obj.style.backgroundColor = '#000099';
        obj.style.color = '#FFFFFF';
        obj.style.cursor = 'pointer';
    }

    function outButton(obj) {
        obj.style.backgroundColor = '#FFFFFF';
        obj.style.color = '#000000';
    }

    function initUI() {
        //init all general UI elements on page, set event handlers
        //init of subpage UI elements should be done in load functions
        var buttons = ['profile_menu', 'corp_menu', 'transactions_menu', 'logout_menu'];
        for (i = 0; i < buttons.length; i++) {
            document.getElementById(buttons[i]).onmouseover = createHandler(document.getElementById(buttons[i]), onButton);
            document.getElementById(buttons[i]).onmouseout = createHandler(document.getElementById(buttons[i]), outButton);
        }
        //init onclick actions
        document.getElementById("profile_menu").onclick = createHandler(selected_account, load_profile);
        document.getElementById("corp_menu").onclick = createHandler(selected_account, load_corp_admin);
        document.getElementById("transactions_menu").onclick = createHandler(selected_account, load_transactions);
        document.getElementById("logout_menu").onclick = createHandler(selected_account, logout);
    }
</script>
</head>
	<body onload="initUI();">
		<div id="wrapper" style="height: 100%; width: 100%">
			<div id="top_menu" style="height: 8%; width: 100%; border-style:solid;">			
				<div id="current_account" style="border-style: solid; width: 20%; height: 80%; float: left; vertical-align: middle;">ACCOUNT NAME</div>
				<div style="border-style: solid; width: 10%; height: 80%; float: left;">
					<div id="profile_menu" style="height: 100%; width: 100%; text-align: center; vertical-align: middle;">Профиль аккаунта</div>
				</div>
				<div style="border-style: solid; width: 10%; height: 80%; float: left;">
					<div id="corp_menu" style=" height: 100%; width: 100%; text-align: center; vertical-align: middle;">Управление</br>корпорацией</div>
				</div>
				<div style="border-style: solid; width: 10%; height: 80%; float: left;">
					<div id="transactions_menu" style="height: 100%; width: 100%; text-align: center; vertical-align: middle;">Транзакции</div>
				</div>				
				<div style="border-style: solid; width: 10%; height: 80%; float: right; vertical-align: middle;">
					<div id="logout_menu" style="height: 100%; width: 100%; text-align: center; vertical-align: middle;">LOGOUT</div>
				</div>
			</div>
			<div id="left_menu" style="height: 90%; width: 20%; border-style:solid; float: left;">
				Left Menu
				<div id="slave_list" style="height: 45%; border-style: solid;">
				Slaves
				</div>
				<br/>
				<div id="master_list" style="height: 45%; border-style: solid;">
				Profile
				</div>
			</div>
			<div id="content_wrapper" style="border-style: solid; width: 79%; height: 90%; float: right; overflow: auto;"></div>
			<script>
			</script>
		</div>
	</body>
</html>
