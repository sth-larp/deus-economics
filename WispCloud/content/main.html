<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>DeusEx Economical Trash</title>

    <link rel="stylesheet" href="./css/styles.css">
    <script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="js/deus_api.js"></script>
    <script type="text/javascript" src="js/slave_box.js"></script>

        <script type="text/javascript">
            var main_account = '';
            var selected_account = '';
            var selected_role = ROLE.MASTER;
            var main_profile = {}
            var lines_on_tab = 10;


        //---------------------------------------------------------------------------------------------------------------------------------------------------
        //mok pages for local testing

        //profile page mok
        var p_page = '<div id="profile_page" style="width:100%; height:100%"> \
	<div><span> Логин: </span><span id="login_name"></span></div>\
    <div><span> Тип: </span><span id="acc_role"></span></div>\
	<div><span> Полное имя: </span><span id="full_name"></span></div>\
	<div><span> Статус: </span><span id="live_status"></span></div>\
    <div><span> Кредиты: </span><span id="current_account_value"></span></div>\
	<span id="index_label" style="display: none;">\
	    <div><span> Индекс: </span><span id="current_index"></span>\
		<span> Очки страховки: </span><span id="index_points"></span></div>\
	</span>\
	<span id="insurance_label" style="display: none;">\
	    <div><span> Страховка: </span>\
        <span id="insurance"></span> \
        (<span id="insurance_level"></span>)\
        </div>\
    </span>\
	<div>\
		<table id="slave_list">\
		</table>\
	</div>\
	<div>\
		<table id="masters_list">\
		</table>	\
	</div>\
	<div>\
		<table id="history">\
		</table>\
	</div>\
	<div id="insurances_supported" style="display: none;">\
		<table id="insurance_supported_list">\
		</table>\
	</div>\
</div>';

        //corp admin page mok
        var ca_page = '<div id="corp_admin" style="width:100%; height:100%">\
	<div id="add_ins_overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 10; background: rgba(150, 150, 150, 0.5);">\
		<div id="add_ins_form" style="vertical-align: middle; width: 350px; height: 100px; display: block; z-index: 11; background: rgba(255, 255, 255, 1); border-style: solid; margin: auto;">\
			<table>\
				<tr><td>Insurance name:</td><td id="ins_name">#CORP</td></tr>\
				<tr><td>Username</td><td><input id="ins_form_user" type="text" value=""/></td></tr>\
				<tr><td>Password</td><td><input id="ins_form_pass" type="password" value=""/></td></tr>\
				<tr><td></td><td><input id="ins_form_ok" type="button" value="Accept"/>\
				<input id="ins_form_no" type="button" value="Decline" onclick="document.getElementById(\'add_ins_overlay\').style.display=\'none\';document.getElementById(\'ins_form_pass\').value=\'\';document.getElementById(\'ins_form_user\').value=\'\';"/></td></tr>\
			</table>\
		</div>\
	</div>\
	<div>\
		<div>Список застрахованных</div>\
		<div id="insurance_users_list">\
		</div>\
	</div>\
	<div id="add_ins_user_button"><input type="button" value="Add insurance" onclick="document.getElementById(\'add_ins_overlay\').style.display=\'block\';"/></div>\
	<hr/>\
	<div>\
		<div>Список зарплат компании</div>\
		<div id="payments_list">\
		</div>	\
	</div>\
</div>';

        //transactions page mok
        var t_page = '<div id="transactions" style="width:100%; height:100%">\
	<div id="trans_menu_holder">\
		<form id="new_transaction" action="">\
			<table>\
				<tr><th>Кому</th><th>Сумма</th><th>Комментарий</th><th></th></tr>\
				<tr>\
					<td><input type="text" id="user_name_id" name="user_name" value="NAME"/></td>\
					<td><input type="text" id="transaction_value_id" name="transaction_value" value="0"/></td>\
					<td><input type="text" id="transaction_comment_id" name="transaction_comment" value="COMMENT"/></td>\
					<td><input type="button" id="send_transaction" name="send" value="SEND"/></td>\
				</tr>\
                <tr><td colspan=4><label class="warning_text" id="transaction_warning"></label></td></tr>\
			</table>\
		</form>\
	</div>\
	<div>\
		<div><span>История операций</span><br/><span>Количество строк на странице</span>\
			<select id="lines_on_tab">\
				<option value="5">5</option>\
				<option value="10">10</option>\
				<option value="20">20</option>\
				<option value="30">30</option>\
				<option value="50">50</option>\
				<option value="100">100</option>\
			</select>\
		</div>\
		<div id="transactions_list">\
		</div>\
	</div>\
</div>';

        //------------------------------------------------------------------------------------------------------------------------------------------------------------
        //check if login is not set, return to login page
        function preLoad()
        {
            try {
                main_account = get_auth_tok_user();
                selected_account = main_account;

                sendAPIRequest(url + "/api/accounts/profile?login=" + main_account, "GET", function(param, status){
                    if (status == 200) {
                        main_profile = JSON.parse(param);
                        document.getElementById("current_account").innerHTML = "Привет, " + main_profile.Login;
                        load_full_profile(main_profile.Login);
                    }
                    else if (status == 401) {
                        loginRedirect();
                    }
                    else{
                        alert(param + "\n\n" + status);
                    }
                });
            }
            catch(e) {
                loginRedirect();
            }
            sendAPIRequest(url + "/api/accounts/access/slaves?master=" + main_account, "GET", function(param, status) {
                if (status == 200)
                    fill_slaves(param, main_account);
            });
        }

        function setCurrentAccount(acc, role) {
            selected_account = acc;
            selected_role = role;
            
            sendAPIRequest(url + "/api/accounts/profile?login=" + selected_account, "GET", function(param, status){
                if (status == 200) {
                    main_profile = JSON.parse(param);
                    load_full_profile(main_profile.Login);
                }
                else{
                    alert(param + "\n\n" + status);
                }
            });
        }

        function buildTabs(elements_list, lines_per_page, page_id_prefix, header_str = ""){
            var result = "";
            var page_links = "";
            //count of pages
            for(offs = 0; offs * lines_per_page < elements_list.length; offs++)
            {
                result = result + "<table id = '" + page_id_prefix + "_" + offs +"' style='display: none'>" + header_str;
                var tmp_limit = lines_per_page;
                for(i = 0; i < tmp_limit; i++) if(offs*lines_per_page + i < elements_list.length) result = result + elements_list[offs*lines_per_page + i];
                result = result + "</table>";
                page_links = page_links + "<span id='"  + page_id_prefix + "_page_" + offs + "'>| " + (offs + 1) + "</span>";
            }
            //change_page_buttons
            result = result + "<div><span id='" + page_id_prefix + "_bookmark' style='display:none'>0</span>";
            result = result + "<span id='" + page_id_prefix + "_maxpage' style='display:none'>" + offs + "</span>"
            result = result + "<span id='" + page_id_prefix + "_back'><< Назад </span>" + page_links + "<span id='" + page_id_prefix + "_fw'> | Вперед >></span></div>";
            return result;
        }
            function initTabsControl(page_id_prefix)
            {
                var max_page = parseInt(document.getElementById(page_id_prefix + "_maxpage").innerHTML);
                var tab_name = "";
                function createPageHandler(page_number){
                    return function(){
                        //for(j = 0; j < max_page; j++) document.getElementById(page_id_prefix + "_" + j).style.display = "none";
                        document.getElementById(page_id_prefix + "_" + parseInt(document.getElementById(page_id_prefix + "_bookmark").innerHTML)).style.display = "none";
                        document.getElementById(page_id_prefix + "_" + page_number).style.display = "block";
                        document.getElementById(page_id_prefix + "_bookmark").innerHTML = page_number;
                    }
                }
                function createArrowHandler(direction)
                {
                    return function(){
                        var cur_page = parseInt(document.getElementById(page_id_prefix + "_bookmark").innerHTML);
                        var new_page = cur_page + direction;
                        if((new_page >=0 && new_page < max_page)){
                            document.getElementById(page_id_prefix + "_bookmark").innerHTML = new_page;
                            document.getElementById(page_id_prefix + "_" + cur_page).style.display = "none";
                            document.getElementById(page_id_prefix + "_" + new_page).style.display = "block";
                        }
                    }
                }
                for(var i = 0; i < max_page; i++){
                    tab_button_name = page_id_prefix + "_page_" + i;
                    document.getElementById(tab_button_name).style.cursor = "pointer";
                    document.getElementById(tab_button_name).onclick = createPageHandler(i);
                }
                document.getElementById(page_id_prefix + "_fw").style.cursor = "pointer";
                document.getElementById(page_id_prefix + "_back").style.cursor = "pointer";
                document.getElementById(page_id_prefix + "_fw").onclick = createArrowHandler(1);
                document.getElementById(page_id_prefix + "_back").onclick = createArrowHandler(-1);
            }

            function insertDocumentToWrapper(wrapper_id, document_href, rq_type){
                //load sub-page into wrapper
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function()
                {
                    if (this.readyState == 4 && this.status == 200) document.getElementById(wrapper_id).innerHTML = xhttp.responseText;
                };
                xhttp.open(rq_type, document_href, true);
                xhttp.setRequestHeader("Authorization", get_auth_tok());
                xhttp.send();
            }

            function fill_full_profile(param) {
                var prof = {};
                if (param.length > 0) {
                    prof = JSON.parse(param);
                    selected_acc_role = get_acc_role(prof.User.Role);
                    //result mapping to visual elements
                    document.getElementById("login_name").innerHTML = prof.User.Login + " ";
                    document.getElementById("acc_role").innerHTML = get_acc_role(prof.User.Role).rusname + " ";
                    document.getElementById("full_name").innerHTML = prof.User.Fullname + " ";
                    document.getElementById("live_status").innerHTML = prof.User.Status + " ";
                    document.getElementById("current_account_value").innerHTML = prof.User.Cash;

                    if (selected_acc_role == ACC_ROLE.CORP) {
                        document.getElementById("current_index").innerHTML = prof.User.Index;
                        document.getElementById("index_points").innerHTML = prof.User.InsurancePoints;
                        document.getElementById("index_label").style.display = "inline";
                        document.getElementById("insurances_supported").style.display = "block";
                    }

                    if (selected_acc_role == ACC_ROLE.PERSON) {
                        document.getElementById("insurance_label").style.display = "inline";
                        document.getElementById("insurance").innerHTML = prof.User.Insurance;
                        document.getElementById("insurance_level").innerHTML = prof.User.InsuranceLevel;
                    }

                    var history_html = "<tr><th>Время</th><th>Событие</th></tr>";
                    for (i = 0; i < prof.History.length; i++) {
                        //history_html = history_html + "<td>" + prof.History[i].Id + "</td>";
                        history_html = history_html + "<tr><td>" + customDateFormat(prof.History[i].Time) + "</td>";
                        history_html = history_html + "<td>" + prof.History[i].Description + "</td>";
                        history_html = history_html + "</tr>";
                    }
                    document.getElementById("history").innerHTML = history_html;
                }
            }

            function load_full_profile() {
                //insertDocumentToWrapper("content_wrapper", url + "/profile_page.html","GET");
                //mok html for localtesting, replace^ before deploy
                document.getElementById("content_wrapper").innerHTML = p_page;

                sendAPIRequest(url + "/api/accounts/fullprofile?login=" + selected_account, "GET", function(param, status) {
                    if (status == 200) fill_full_profile(param);
                    else alert(param + "\n\nStatus " + status);
                });

                //get masters
                sendAPIRequest(url + "/api/accounts/access/masters?slave=" + selected_account, "GET", function(param, status){
                });
                //get supported insurances (for corps only)

            }

            function load_transactions() {

                //insertDocumentToWrapper("content_wrapper", url + "/transactions.html","GET");
                //mok html for localtesting, replace^ before deploy
                document.getElementById("content_wrapper").innerHTML = t_page;
                document.getElementById("trans_menu_holder").style.visibility =
                        selected_role.value >= ROLE.WITHDRAW.value ? 'visible' : 'hidden';

                document.getElementById("send_transaction").onclick = function() { sendTransaction();};
                load_transactions_table();
            }

            function load_transactions_table() {
                document.getElementById("lines_on_tab").value = lines_on_tab;
                document.getElementById("lines_on_tab").onchange = function(){
                    lines_on_tab = document.getElementById("lines_on_tab").value;
                    //should rebuild transactions table here
                    sendAPIRequest(url + "/api/transactions?login=" + selected_account, "GET", function(param, status){
                        fill_transactions_table(param, status)});
                }
                sendAPIRequest(url + "/api/transactions?login=" + selected_account, "GET", function(param, status) {
                    fill_transactions_table(param, status);});
            }

            function sendTransaction(elem) {
                var user = document.getElementById("user_name_id").value;
                var sum = document.getElementById("transaction_value_id").value;
                var comment = document.getElementById("transaction_comment_id").value;
                var txtField = document.getElementById("transaction_warning");
                var data = JSON.stringify({"Sender": selected_account, "Receiver": user, "Amount": sum, "Comment" : comment});

                sendAPIRequest(url + "/api/transfer", "POST", function(param, status) {
                    if (status == 200) {
                        txtField.innerHTML = "";
                        load_transactions_table();
                    } 
                    else
                        txtField.innerHTML = param;
                }, data);
            }

            function fill_transactions_table(param, status) {
                if (status != 200) {
                    document.getElementById("transactions_list").innerHTML = "Error " + status + "\n" + param;
                    return;
                }

                var t_list = JSON.parse(param);
                var head_str = "<tr><th>Id</th><th>Отправитель</th><th>Получатель</th><th>Дата</th><th>Сумма</th><th>Комментарий</th></tr>";
                var page_str = "";
                var t_str = [];
                for (i = 0; i < t_list.length; i++) {
                    t_str[i] = "<tr><td>" + t_list[i].Id + "</td><td>" + t_list[i].Sender 
                    + "</td><td>" + t_list[i].Receiver + "</td><td>" + customDateFormat(t_list[i].Time) 
                    + "</td><td>" + t_list[i].Amount + "</td><td>" + t_list[i].Comment + "</td></tr>";
                }
                page_str = buildTabs(t_str, lines_on_tab, "transaction_table", head_str);
                document.getElementById("transactions_list").innerHTML = page_str;
                document.getElementById("transaction_table_0").style.display = "block";
                initTabsControl("transaction_table");
            }

            function load_corp_admin() {
                //insertDocumentToWrapper("content_wrapper", url + "/transactions.html","GET");
                //mok html for localtesting, replace^ before deploy
                document.getElementById("content_wrapper").innerHTML = ca_page;
				//insurances
                sendAPIRequest(url + "/api/insurance/loyalties?login=" + selected_account, "GET", function(param, status) {
                    if (status == 200) 
					{
						var loyalties_list = [];
						var head_str = "<tr><th>Id</th><th>Страховка</th><th>Уровень</th><th>Держатель</th></tr>";
						var page_str = "";
						var l_str = [];												
						loyalties_list = JSON.parse(param);						
						page_str = buildTabs(loyalties_list, lines_on_tab, "loyalties_table", head_str);
						document.getElementById("insurance_users_list").innerHTML = page_str;
						document.getElementById("loyalties_table_0").style.display = "block";
						initTabsControl("loyalties_table");
					}
                    else alert(param + "\n\nStatus " + status);
                });
				//payments
                sendAPIRequest(url + "/api/payments/list?login=" + selected_account, "GET", function(param, status) {
                    if (status == 200) 
					{
						var payments_list = [];
						var head_str = "<tr><th>Id</th><th>Employer</th><th>EmployerName</th><th>Receiver</th><th>LastPaid</th><th>Period</th><th>Debt</th><th>Amount</th><th>Flags</th></tr>";
						var page_str = "";
						var l_str = [];												
						loyalties_list = JSON.parse(param);						
						page_str = buildTabs(payments_list, lines_on_tab, "payments_table", head_str);
						document.getElementById("payments_list").innerHTML = page_str;
						document.getElementById("payments_table_0").style.display = "block";
						initTabsControl("payments_table");
					}
                    else alert(param + "\n\nStatus " + status);
                });				
            }
            function createHandler(obj, handler) {
                return function() { handler(obj); }
            }

            function onButton(obj) {
                obj.style.backgroundColor = '#000099';
                obj.style.color = '#FFFFFF';
                obj.style.cursor = 'pointer';
            }

            function outButton(obj) {
                obj.style.backgroundColor = '#FFFFFF';
                obj.style.color = '#000000';
            }

            function initUI() {
                preLoad();
                //init all general UI elements on page, set event handlers
                //init of subpage UI elements should be done in load functions
                var buttons = ['profile_menu', 'corp_menu', 'transactions_menu', 'logout_menu'];
                for (i = 0; i < buttons.length; i++) {
                    document.getElementById(buttons[i]).onmouseover = createHandler(document.getElementById(buttons[i]), onButton);
                    document.getElementById(buttons[i]).onmouseout = createHandler(document.getElementById(buttons[i]), outButton);
                }
                //init onclick actions
                document.getElementById("profile_menu").onclick = function() { load_full_profile();};
                document.getElementById("corp_menu").onclick = function() { load_corp_admin();};
                document.getElementById("transactions_menu").onclick = function() { load_transactions();};
                document.getElementById("logout_menu").onclick = function() { loginRedirect();};
            }
    </script>
</head>
<body onload="initUI();">
    <div id="wrapper" style="height: 100%; width: 100%">
        <div id="top_menu" style="height: 8%; width: 100%; border-style:solid;">
            <div id="current_account" style="border-style: solid; width: 20%; height: 80%; float: left; vertical-align: middle;">ACCOUNT NAME</div>
            <div style="border-style: solid; width: 10%; height: 80%; float: left;">
                <div id="profile_menu" style="height: 100%; width: 100%; text-align: center; vertical-align: middle;">Профиль</div>
            </div>
            <div style="border-style: solid; width: 10%; height: 80%; float: left;">
                <div id="corp_menu" style=" height: 100%; width: 100%; text-align: center; vertical-align: middle;">Управление</div>
            </div>
            <div style="border-style: solid; width: 10%; height: 80%; float: left;">
                <div id="transactions_menu" style="height: 100%; width: 100%; text-align: center; vertical-align: middle;">Транзакции</div>
            </div>
            <div style="border-style: solid; width: 10%; height: 80%; float: right; vertical-align: middle;">
                <div id="logout_menu" style="height: 100%; width: 100%; text-align: center; vertical-align: middle;">LOGOUT</div>
            </div>
        </div>
        <div id="left_menu" style="height: 90%; width: 20%; border-style:solid; float: left;">
            <div id="slave_list" style="height: 45%; border-style: solid;">
                Ваши счета
                <table id="slave_table" class="slave_table">
                </table>
            </div>
            <br/>
            <div id="master_list" style="height: 45%; border-style: solid;">
                Profile
            </div>
        </div>
        <div id="content_wrapper" style="border-style: solid; width: 79%; height: 90%; float: right; overflow: auto;"></div>
        <script>
        </script>
    </div>
</body>
</html>
