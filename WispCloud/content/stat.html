<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>DeusEx Economics</title>

<link rel="stylesheet" href="./css/styles.css">
<link rel="stylesheet" href="./css/top-menu.css">
<link rel="stylesheet" href="./css/left-menu.css">
<link rel="stylesheet" href="./css/mobile.css" media="(max-device-width:800px)">
<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="js/deus_api.js"></script>
<script type="text/javascript" src="js/slave_box.js"></script>

<script type="text/javascript">
    var main_account = '';
    var lines_on_tab = 20;


    //------------------------------------------------------------------------------------------------------------------------------------------------------------
    // Навигация левого меню
    //------------------------------------------------------------------------------------------------------------------------------------------------------------


    function preLoad() {
        main_account = get_auth_tok_user();
        load_const_page();
    }

    //------------------------------------------------------------------------------------------------------------------------------------------------------------
    // Страница констант
    //------------------------------------------------------------------------------------------------------------------------------------------------------------

    function load_constants() {
        $("#const-table tbody tr").remove();

        sendAPIRequestWarned(url + "/api/constant/list", "GET", function (param, status) {
            $('#const-table').append('<tr><th>Имя</th><th>Значение</th><th>Описание</th><th></th></tr>');
            var consts = JSON.parse(param);
            var row = "<tr><td>{0}</td><td>{1}</td><td>{2}</td><td></td></tr>";

            for (i = 0; i < consts.length; i++) {
                if (consts[i].Name == "LastCycle") {
                    var date = new Date(new Date('2017-01-01').getTime() + consts[i].Value * 1000);
                    consts[i].Value = formatDate(date, "d MMM HH:mm:ss");
                }
                var txt = format(row, [consts[i].Name, consts[i].Value, consts[i].Description]);
                $('#const-table').append(txt);
            }
        }, "const-table-warning");
    }

    function load_const_page() {
        topMenuSwitch("const");
        load_constants();
    }

    //------------------------------------------------------------------------------------------------------------------------------------------------------------
    // Страница статистики
    //------------------------------------------------------------------------------------------------------------------------------------------------------------

    function load_implants() {
        $("#implant-table tbody tr").remove();

        sendAPIRequestWarned(url + "/api/stat/alice", "GET", function (param, status) {
            $('#implant-table').append('<tr><th>Корпорация</th><th>Импланты</th></tr>');
            var doc = JSON.parse(param);
            var implants = doc.Implants;
            var vr = doc.TimeInVR;
            var row = "<tr><td>{0}</td><td>{1}</td></tr>";

            $('#implant-table').append(format(row, ["JJ", implants.JJ]));
            $('#implant-table').append(format(row, ["Panam", implants.Panam]));
            $('#implant-table').append(format(row, ["Serenity", implants.Serenity]));
            $('#implant-table').append(format(row, ["Время в VR", vr]));
        }, "implant-table-warning");
    }

    //------------------------------------------------------------------------------------------------------------------------------------------------------------
    // Страница страховок
    //------------------------------------------------------------------------------------------------------------------------------------------------------------

    function load_insurances() {
        $("#ins-table tbody tr").remove();

        sendAPIRequestWarned(url + "/api/accounts/list", "GET", function (param, status) {
            $('#ins-table').append('<tr><th>Эмитент</th><th>Ур1</th><th>Ур2</th><th>Ур3</th></tr>');
            var row = "<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td></tr>";

            var persons = JSON.parse(param);
            var dict = {};

            for (i = 0; i < persons.length; i++)
                dict[persons[i].Insurance] = [0,0,0,0];

            for (i = 0; i < persons.length; i++) 
                dict[persons[i].Insurance][persons[i].InsuranceLevel] += 1;

            for (var key in dict) {
                var txt = format(row, [key, dict[key][1], dict[key][2], dict[key][3]]);
                if(key == 'None') continue;
                    $('#ins-table').append(txt);
            }
            
        }, "ins-table-warning");
    }

    //------------------------------------------------------------------------------------------------------------------------------------------------------------
    // Страница Транзакций
    //------------------------------------------------------------------------------------------------------------------------------------------------------------



    function load_trans_stat() {
        $("#trans-20in tbody tr").remove();
        $("#trans-20out tbody tr").remove();
        $("#trans-50 tbody tr").remove();

        sendAPIRequestWarned(url + "/api/stat/transfers", "GET", function (param, status) {
            $('#trans-20in').append('<tr><th>Компания</th><th>Входящие переводы</th></tr>');
            $('#trans-20out').append('<tr><th>Компания</th><th>Исходящие переводы</th></tr>');
            $('#trans-50').append('<tr><th>Персона</th><th>Входящие переводы</th></tr>');

            var data = JSON.parse(param);
            var row = "<tr><td><a href='./main.html?current={2}' target='_blank'>{0}</a></td><td>{1}</td></tr>";

            for (var i in data.Top20CompReceivers) {
                var txt = format(row, [data.Top20CompReceivers[i].Fullname, data.Top20CompReceivers[i].Amount, data.Top20CompReceivers[i].Login]);
                $('#trans-20in').append(txt);
            }

            for (var i in data.Top20CompSenders) {
                var txt = format(row, [data.Top20CompSenders[i].Fullname, data.Top20CompSenders[i].Amount, data.Top20CompSenders[i].Login]);
                $('#trans-20out').append(txt);
            }

            for (var i in data.Top50PersReceivers) {
                var txt = format(row, [data.Top50PersReceivers[i].Fullname, data.Top50PersReceivers[i].Amount, data.Top50PersReceivers[i].Login]);
                $('#trans-50').append(txt);
            }

        }, "trans-table-warning");
    }

    function topMenuSwitch(prefix) {
        $('.top-menu-elem').removeClass('top-menu-selected');
        document.getElementById(prefix + "-menu").classList.add('top-menu-selected');
        $('.page-display').css('display', 'none');
        document.getElementById(prefix + "-page").style.display = 'block';
    }

</script>
</head>


<body onload="preLoad();">

<div id="top_menu" class="top-menu">
    <div class="top-menu-elem greetings">
        <span id="current_account"></span>
    </div>
    <div id="const-menu" class="top-menu-elem top-menu-selected" onclick="load_const_page();">Константы</div>
    <div id="alice-menu" class="top-menu-elem" onclick="topMenuSwitch('alice');">ALICE</div>
    <div id="ins-menu" class="top-menu-elem" onclick="topMenuSwitch('ins');">Страховки</div>
    <div id="trans-menu" class="top-menu-elem" onclick='topMenuSwitch("trans");'>Переводы</div>
    <div id="logout_menu" class="top-menu-elem logout" onclick="loginRedirect();">Выйти</div>
</div>

<div id="content-wrapper">
    <div id="content-preceder"></div>
    <div id="content-body">

        <!-- Страница Константы -->
        <div id="const-page" class="page-display">
            <div id="const-holder">
                <h2>Константы</h2>
                <table id="const-table"></table>
                <div class="warning-text" id="const-table-warning"></div>
            </div>
        </div>

        <!-- Страница ALICE -->
        <div id="alice-page" class="page-display">
            <div id="implant-holder">
                <input type="button" class="custom-button smaller" name="Обновить статистику имплантов" value="Обновить статистику имплантов" onclick="value = name + curUpdateStr(); load_implants();" />

                <h2>Импланты в игре</h2>
                <table id="implant-table"></table>
                <div class="warning-text" id="implant-table-warning"></div>
            </div>
        </div>

        <!-- Страница Страховки -->
        <div id="ins-page" class="page-display">
            <div id="ins-holder">
                <input type="button" class="custom-button smaller" name="Обновить статистику страховок" value="Обновить статистику страховок" onclick="value = name + curUpdateStr(); load_insurances();" />

                <h2>Активные страховки</h2>
                <table id="ins-table"></table>
                <div class="warning-text" id="ins-table-warning"></div>
            </div>
        </div>

        <!-- Страница Переводы -->
        <div id="trans-page" class="page-display">
            <div id="trans-holder">
                <input type="button" class="custom-button smaller" name="Обновить статистику переводов" value="Обновить статистику переводов" onclick="value = name + curUpdateStr(); load_trans_stat();"/>

                <h2>Топ-20 компаний по исходящим переводам</h2>
                <p> Считается с начала цикла, не учитываются выплаты по зарплатам и страховкам</p>
                <table id="trans-20out"></table>
                <div class="warning-text" id="trans-table-warning"></div>

                <h2>Топ-20 компаний по входящим переводам</h2>
                <p> Считается с начала цикла, не учитываются выплаты по зарплатам и страховкам</p>
                <table id="trans-20in"></table>

                <h2>Топ-50 персон по входящим переводам</h2>
                <p> Считается с начала цикла, не учитываются выплаты по зарплатам и страховкам</p>
                <table id="trans-50"></table>

            </div>
        </div>

    </div>
</div>


</body>
</html>
